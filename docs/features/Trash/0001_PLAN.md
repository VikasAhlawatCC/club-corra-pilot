# Feature 0001: User Signup & Authentication

## Brief Description
Implement comprehensive user authentication system with mobile number + email OTP verification and OAuth 2.0 support. Mobile number signup is mandatory, with optional UPI/payment details collection. System will collect first name, last name, and other necessary user information during signup.

## Technical Requirements

### Core Authentication Flow
1. **Mobile Number Verification (Required)**
   - User enters mobile number
   - System sends OTP via SMS
   - User verifies OTP to validate mobile number
   - Mobile number becomes primary identifier

2. **Email Verification OR OAuth 2.0 (Required - Choose One)**
   - **Option A: Email Verification**
     - User enters email address
     - System sends OTP via email
     - User verifies OTP to validate email
   - **Option B: OAuth 2.0 Integration**
     - Google OAuth 2.0 provider
     - Facebook OAuth 2.0 provider
     - System automatically collects and verifies email from OAuth provider
   - Email used for communications and account management

4. **User Profile Collection (Required)**
   - First name (required)
   - Last name (required)
   - Date of birth (optional)

5. **Payment Details (Optional/Skippable)**
   - UPI ID (optional)
   - Can be completed later in user journey

## Files and Functions to Create/Modify

### Phase 1: Data Layer & Types
**packages/shared/src/types.ts**
- `User` interface with authentication fields
- `AuthProvider` enum (SMS, EMAIL, GOOGLE, FACEBOOK)
- `UserProfile` interface for profile data
- `PaymentDetails` interface for UPI/payment info
- `OTPVerification` interface for verification flow

**packages/shared/src/schemas/**
- `user.schema.ts` - Zod schemas for validation
- `auth.schema.ts` - Authentication request/response schemas

### Phase 2A: Backend API (NestJS)
**apps/api/src/auth/**
- `auth.module.ts` - Authentication module
- `auth.controller.ts` - Auth endpoints (signup, login, verify OTP)
- `auth.service.ts` - Business logic for auth flows
- `jwt.strategy.ts` - JWT authentication strategy
- `local.strategy.ts` - Local strategy for OTP verification

**apps/api/src/users/**
- `users.module.ts` - Users module
- `users.controller.ts` - User profile management
- `users.service.ts` - User business logic
- `user.entity.ts` - TypeORM entity

**apps/api/src/common/**
- `otp.service.ts` - OTP generation and verification
- `sms.service.ts` - SMS integration (Twilio/AWS SNS)
- `email.service.ts` - Email service (SendGrid/AWS SES)

**Database Migrations**
- Create users table with auth fields
- Create user_profiles table
- Create payment_details table
- Create auth_providers table for OAuth linking

### Phase 2B: Mobile App (React Native)
**apps/mobile/src/screens/auth/**
- `SignupScreen.tsx` - Main signup flow
- `OTPVerificationScreen.tsx` - OTP input and verification
- `ProfileSetupScreen.tsx` - Collect user profile data
- `PaymentSetupScreen.tsx` - Optional payment details

**apps/mobile/src/components/auth/**
- `PhoneInput.tsx` - Mobile number input with validation
- `EmailInput.tsx` - Email input with validation
- `OTPInput.tsx` - OTP input component
- `ProfileForm.tsx` - User profile form
- `PaymentForm.tsx` - Payment details form

**apps/mobile/src/services/**
- `auth.service.ts` - Authentication API calls
- `otp.service.ts` - OTP handling logic

**apps/mobile/src/stores/**
- `auth.store.ts` - Authentication state management
- `user.store.ts` - User profile state


## Algorithms and Implementation Details

### OTP Generation and Verification
1. **OTP Generation**
   - Generate 6-digit numeric OTP
   - Store OTP hash in database with expiration (5 minutes)
   - Send OTP via SMS/email service

2. **OTP Verification**
   - Hash user input and compare with stored hash
   - Check expiration time
   - Mark mobile/email as verified upon successful verification

### JWT Token Management
1. **Token Generation**
   - Create JWT with user ID, mobile number, and roles
   - Set expiration (7 days for mobile, 24 hours for web)
   - Include refresh token for mobile apps

2. **Token Refresh**
   - Validate refresh token
   - Generate new access token
   - Maintain user session

### OAuth 2.0 Integration
1. **Provider Authentication**
   - Redirect to OAuth provider
   - Handle callback with authorization code
   - Exchange code for access token
   - Fetch user profile from provider (including email)

2. **Account Linking**
   - Verify mobile number exists
   - Link OAuth account to existing user
   - Create new user if mobile not found
   - Use OAuth email as verified email (no additional verification needed)

### User Profile Flow
1. **Required Fields Collection**
   - First name (required)
   - Last name (required)
   - Mobile number (verified)
   - Email (verified via OTP or OAuth)

2. **Optional Fields**
   - Profile picture upload
   - Date of birth
   - Gender
   - Address information

3. **Payment Details (Skippable)**
   - UPI ID validation
   - Payment method selection
   - Can be completed later via profile settings

## Security Considerations
- OTP expiration and rate limiting
- JWT token rotation
- Secure storage of refresh tokens
- Input validation and sanitization
- CORS configuration for OAuth callbacks
- Rate limiting for signup attempts

## Integration Points
- SMS service (Twilio/AWS SNS)
- Email service (SendGrid/AWS SES)
- OAuth providers (Google, Facebook)
- JWT token management
- User profile storage
- Payment details storage

### Phase 3: Integration
**Cross-Platform Integration**
- Ensure shared types and schemas work across all platforms
- Test authentication flow end-to-end between mobile, API, and admin
- Verify JWT token sharing between mobile and web applications
- Test OAuth flow integration with mobile deep linking

### Phase 4: Testing
**API Integration Testing**
- Test all auth endpoints with Postman/Insomnia
- Verify OTP generation and verification across SMS and email
- Test OAuth callback handling and account linking
- Validate JWT token refresh mechanism

**Mobile-API Integration**
- Test mobile app authentication with real API endpoints
- Verify OTP input and verification flow
- Test profile data synchronization
- Validate payment details storage and retrieval


**End-to-End Testing**
- Complete user signup flow from mobile
- Test OAuth signup flow with mobile number verification
- Verify profile updates sync across all platforms
- Test payment details optional flow and later completion
