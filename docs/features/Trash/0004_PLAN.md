# Feature 0004: Complete Coin Earning & Redemption System

## Brief Description

Build a complete product with the currently implemented system that allows users to earn or redeem Corra coins through brand partnerships. Users can upload bills to earn coins based on brand-specific percentages, while admins can manage brand configurations, approve/reject requests, and process manual payments. The system includes real-time coin balance updates, transaction history tracking, and notification systems.

## Current Implementation Analysis

The codebase already has:
- Brand entities with earning/redemption percentages (x% and y%)
- Coin transaction entities with status management (PENDING, APPROVED, REJECTED, PROCESSED)
- Basic admin controllers for brand CRUD operations
- Shared schemas for validation
- Database migrations for core tables

## Required Changes

### 1. Data Layer Updates

#### Brand Entity Enhancements
**File**: `apps/api/src/brands/entities/brand.entity.ts`
- Add `overallMaxCap` field (decimal, precision 10, scale 2) for brand-wide maximum redemption limit
- Add `brandwiseMaxCap` field (decimal, precision 10, scale 2) for per-transaction maximum redemption limit
- Update validation rules to ensure caps are properly enforced

#### Coin Transaction Entity Updates
**File**: `apps/api/src/coins/entities/coin-transaction.entity.ts`
- Add `transactionId` field (varchar, length 100) for admin payment tracking
- Add `billDate` field (date) for receipt validation
- Update status enum to include 'PAID' status for completed redemptions
- Add `paymentProcessedAt` timestamp for payment completion tracking

#### New Migration
**File**: `apps/api/src/migrations/1700000000004-AddBrandCapsAndPaymentTracking.ts`
- Add new columns to brands table
- Add new columns to coin_transactions table
- Update existing constraints and indexes

### 2. Business Logic Implementation

#### Enhanced Coins Service
**File**: `apps/api/src/coins/coins.service.ts`
- Implement `createEarnRequest()` method with bill validation
- Implement `createRedeemRequest()` method with balance and pending request checks
- Implement `approveEarnRequest()` method with coin distribution
- Implement `rejectEarnRequest()` method with coin rollback
- Implement `approveRedeemRequest()` method with payment processing
- Implement `processPayment()` method with transaction ID validation

#### Business Rules Engine
**File**: `apps/api/src/coins/services/transaction-validation.service.ts` (new)
- Validate user has sufficient balance for redemption
- Check all pending earn requests are processed before redemption approval
- Enforce brand-specific earning and redemption caps
- Validate bill amounts and dates

#### Real-time Balance Updates
**File**: `apps/api/src/coins/services/balance-update.service.ts` (new)
- Implement immediate balance updates for earn requests
- Handle balance rollbacks for rejected requests
- Maintain transaction audit trail

### 3. API Endpoints

#### User Transaction Endpoints
**File**: `apps/api/src/coins/controllers/coin-transaction.controller.ts` (new)
- `POST /transactions/earn` - Submit earn request with bill
- `POST /transactions/redeem` - Submit redemption request
- `GET /transactions` - Get user transaction history
- `GET /transactions/:id` - Get specific transaction details

#### Admin Management Endpoints
**File**: `apps/api/src/coins/controllers/coin-admin.controller.ts`
- `GET /admin/transactions` - List all pending requests with filtering
- `PUT /admin/transactions/:id/approve` - Approve earn/redemption request
- `PUT /admin/transactions/:id/reject` - Reject request with notes
- `PUT /admin/transactions/:id/process-payment` - Process payment with transaction ID
- `GET /admin/transactions/pending` - Get pending requests by type

#### Brand Management Endpoints
**File**: `apps/api/src/brands/brands.controller.ts`
- Update existing endpoints to handle new cap fields
- Add validation for cap constraints

### 4. Shared Package Updates

#### Enhanced Schemas
**File**: `packages/shared/src/schemas/coin.schema.ts`
- Add `overallMaxCap` and `brandwiseMaxCap` to brand schemas
- Add `transactionId` and `billDate` to transaction schemas
- Add new status values and payment processing schemas
- Add validation for payment transaction IDs

#### New Types
**File**: `packages/shared/src/types.ts`
- Add `TransactionStatus` enum with new statuses
- Add `PaymentProcessingRequest` interface
- Add `TransactionValidationResult` interface

### 5. Mobile App Implementation

#### Transaction Screens
**File**: `apps/mobile/src/screens/transactions/` (new directory)
- `EarnCoinsScreen.tsx` - Bill upload and submission
- `RedeemCoinsScreen.tsx` - Redemption request form
- `TransactionHistoryScreen.tsx` - List all transactions with status
- `TransactionDetailScreen.tsx` - Detailed transaction view

#### Transaction Store
**File**: `apps/mobile/src/stores/transactions.store.ts` (new)
- Manage transaction state and API calls
- Handle real-time balance updates
- Cache transaction history

#### Transaction Service
**File**: `apps/mobile/src/services/transactions.service.ts` (new)
- API calls for earn/redemption requests
- File upload handling for bills
- Real-time status updates

#### Home Screen Updates
**File**: `apps/mobile/src/screens/(tabs)/home.tsx`
- Display brands with earning/redemption percentages
- Show current coin balance
- Quick access to earn/redeem actions

### 6. Admin Portal Implementation

#### Transaction Management
**File**: `apps/admin/src/components/transactions/` (new directory)
- `TransactionTable.tsx` - List all transactions with filtering
- `TransactionDetailModal.tsx` - View transaction details and receipt
- `TransactionActionButtons.tsx` - Approve/reject/pay actions
- `PaymentProcessingModal.tsx` - Enter transaction ID for payments

#### Enhanced Brand Management
**File**: `apps/admin/src/components/brands/BrandForm.tsx` (update)
- Add fields for overall and brandwise max caps
- Enhanced validation for percentage and cap constraints
- Better error handling and user feedback

#### Dashboard Updates
**File**: `apps/admin/src/app/page.tsx`
- Show pending request counts
- Display recent transactions
- Quick action buttons for common tasks

### 7. Real-time Features

#### WebSocket Integration
**File**: `apps/api/src/websocket/` (new directory)
- `websocket.gateway.ts` - Handle real-time connections
- `notification.service.ts` - Send real-time updates
- `connection.manager.ts` - Manage user connections

#### Notification System
**File**: `apps/api/src/notifications/` (new directory)
- `notification.entity.ts` - Store notification data
- `notification.service.ts` - Create and send notifications
- `push-notification.service.ts` - Mobile push notifications

#### Real-time Updates
**File**: `apps/mobile/src/providers/RealTimeProvider.tsx` (new)
- WebSocket connection management
- Real-time balance updates
- Push notification handling

### 8. File Upload & Storage

#### S3 Integration
**File**: `apps/api/src/files/` (new directory)
- `file.service.ts` - Handle file uploads and S3 operations
- `file.controller.ts` - Generate signed URLs for uploads
- `file.entity.ts` - Track uploaded files

#### Bill Validation
**File**: `apps/api/src/coins/services/bill-validation.service.ts` (new)
- Basic image validation
- File size and format checks
- OCR integration for receipt processing (future enhancement)

## Implementation Phases

### Phase 1: Data Layer & Core Business Logic (Week 1)
- Create new migration for brand caps and payment tracking
- Update entities with new fields
- Implement core business logic services
- Add transaction validation rules

### Phase 2A: Backend API & Services (Week 2)
- Implement new API endpoints
- Add file upload and S3 integration
- Create notification and real-time services
- Add comprehensive error handling

### Phase 2B: Admin Portal UI (Week 2)
- Build transaction management components
- Enhance brand management forms
- Add dashboard widgets
- Implement real-time updates

### Phase 2C: Mobile App UI (Week 2)
- Create transaction screens
- Implement file upload functionality
- Add real-time balance updates
- Build notification system

### Phase 3: Integration & Testing (Week 3)
- End-to-end testing of all workflows
- Real-time feature testing
- Performance optimization
- Security audit

## Key Algorithms

### 1. Redemption Approval Algorithm
```
1. Check if user has sufficient coin balance
2. Verify all pending earn requests are processed (approved/rejected)
3. Calculate redemption amount based on brand percentage
4. Validate against brand caps (overall and brandwise)
5. Create redemption transaction with PENDING status
6. Reserve coins from user balance
```

### 2. Earn Request Processing Algorithm
```
1. Validate bill image and details
2. Calculate coins to earn based on brand percentage
3. Check against brand earning caps
4. Immediately add coins to user balance
5. Create earn transaction with PENDING status
6. Send notification to admin for verification
```

### 3. Payment Processing Algorithm
```
1. Admin enters transaction ID from manual payment
2. Validate transaction ID format and uniqueness
3. Update redemption transaction status to PAID
4. Record payment timestamp and transaction ID
5. Send notification to user about payment completion
6. Update audit trail for compliance
```

### 4. Real-time Balance Update Algorithm
```
1. User action triggers balance change
2. Update database balance immediately
3. Broadcast change via WebSocket to connected clients
4. Update mobile app state in real-time
5. Send push notification if app is not active
6. Log all balance changes for audit
```

## Technical Considerations

### Performance
- Use database transactions for atomic operations
- Implement connection pooling for WebSocket connections
- Cache frequently accessed brand data
- Use database indexes for transaction queries

### Security
- Validate all file uploads and sanitize inputs
- Implement rate limiting for API endpoints
- Use signed URLs for S3 access
- Audit all admin actions

### Scalability
- Design WebSocket architecture for horizontal scaling
- Use Redis for session management and caching
- Implement database read replicas for heavy queries
- Design for eventual consistency in real-time updates

### Monitoring
- Track transaction processing times
- Monitor WebSocket connection health
- Log all business rule validations
- Alert on failed payment processing
