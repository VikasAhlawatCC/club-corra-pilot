# Feature 0002: Welcome Bonus and Brand Discovery

## Brief Description

Implement the Welcome Bonus system that awards 100 Corra Coins to new users upon account creation, and create the Brand Discovery feature that allows users to browse partner brands with their earning/redeeming capabilities. This includes the data layer for brands, coins system, and the UI components for both mobile and admin applications.

## Files and Functions to Change/Create

### Phase 1: Data Layer (Database & Entities)

#### New Database Entities
- **`apps/api/src/brands/entities/brand.entity.ts`** - Brand entity with earning/redeeming rules
- **`apps/api/src/coins/entities/coin-balance.entity.ts`** - User coin balance tracking
- **`apps/api/src/coins/entities/coin-transaction.entity.ts`** - Coin transaction history
- **`apps/api/src/brands/entities/brand-category.entity.ts`** - Brand categorization

#### Database Migration
- **`apps/api/src/migrations/1700000000001-AddBrandsAndCoins.ts`** - New migration for brands and coins tables

#### Shared Types & Schemas
- **`packages/shared/src/types.ts`** - Add brand and coin related types
- **`packages/shared/src/schemas/brand.schema.ts`** - Zod schemas for brand validation
- **`packages/shared/src/schemas/coin.schema.ts`** - Zod schemas for coin validation

### Phase 2A: Backend API (NestJS)

#### New Modules
- **`apps/api/src/brands/brands.module.ts`** - Brands module with CRUD operations
- **`apps/api/src/coins/coins.module.ts`** - Coins module for balance and transactions
- **`apps/api/src/brands/brands.controller.ts`** - REST endpoints for brand operations
- **`apps/api/src/coins/coins.controller.ts`** - REST endpoints for coin operations

#### Services
- **`apps/api/src/brands/brands.service.ts`** - Brand business logic
- **`apps/api/src/coins/coins.service.ts`** - Coin balance and transaction logic
- **`apps/api/src/users/users.service.ts`** - Update to include welcome bonus logic

#### DTOs
- **`apps/api/src/brands/dto/create-brand.dto.ts`** - Brand creation validation
- **`apps/api/src/brands/dto/update-brand.dto.ts`** - Brand update validation
- **`apps/api/src/coins/dto/coin-transaction.dto.ts`** - Transaction creation validation

### Phase 2B: Mobile App (React Native)

#### New Screens
- **`apps/mobile/app/brands/index.tsx`** - Brand discovery main screen
- **`apps/mobile/app/brands/[id].tsx`** - Individual brand detail screen
- **`apps/mobile/app/coins/index.tsx`** - Coin balance and history screen

#### Components
- **`apps/mobile/src/components/brands/BrandCard.tsx`** - Individual brand display card
- **`apps/mobile/src/components/brands/BrandList.tsx`** - Scrollable brand list
- **`apps/mobile/src/components/brands/BrandSearch.tsx`** - Brand search and filtering
- **`apps/mobile/src/components/coins/CoinBalance.tsx`** - Coin balance display
- **`apps/mobile/src/components/coins/TransactionHistory.tsx`** - Transaction list

#### Services
- **`apps/mobile/src/services/brands.service.ts`** - Brand API integration
- **`apps/mobile/src/services/coins.service.ts`** - Coin API integration

#### Stores
- **`apps/mobile/src/stores/brands.store.ts`** - Brand state management
- **`apps/mobile/src/stores/coins.store.ts`** - Coin state management

### Phase 2C: Admin Portal (Next.js)

#### New Pages
- **`apps/admin/app/brands/page.tsx`** - Brand management dashboard
- **`apps/admin/app/brands/[id]/page.tsx`** - Brand edit page
- **`apps/admin/app/brands/new/page.tsx`** - Brand creation page
- **`apps/admin/app/coins/page.tsx`** - Coin system overview

#### Components
- **`apps/admin/src/components/brands/BrandForm.tsx`** - Brand creation/editing form
- **`apps/admin/src/components/brands/BrandTable.tsx`** - Brand data table
- **`apps/admin/src/components/coins/CoinOverview.tsx`** - Coin system statistics

#### API Routes
- **`apps/admin/src/app/api/brands/route.ts`** - Brand CRUD operations
- **`apps/admin/src/app/api/coins/route.ts`** - Coin system operations

### Phase 3: Integration & Welcome Bonus Logic

#### Welcome Bonus Implementation
- **`apps/api/src/users/users.service.ts`** - Add welcome bonus logic in user creation
- **`apps/api/src/coins/coins.service.ts`** - Welcome bonus transaction creation
- **`apps/mobile/src/stores/auth.store.ts`** - Update to show welcome bonus notification

#### App Module Updates
- **`apps/api/src/app.module.ts`** - Import new brands and coins modules
- **`apps/mobile/app/_layout.tsx`** - Add brands and coins to navigation
- **`apps/admin/app/layout.tsx`** - Add brands and coins to admin navigation

## Algorithms and Business Logic

### Welcome Bonus Algorithm
1. **User Creation Trigger**: When a new user completes profile setup and payment details
2. **Bonus Validation**: Check if user is eligible (first-time user, verified mobile)
3. **Coin Creation**: Create initial balance of 100 Corra Coins
4. **Transaction Record**: Log welcome bonus transaction with type "WELCOME_BONUS"
5. **Notification**: Send push notification to user about welcome bonus

### Brand Discovery Algorithm
1. **Brand Fetching**: Retrieve active brands with pagination and filtering
2. **Category Grouping**: Group brands by category for organized display
3. **Search Functionality**: Implement fuzzy search across brand names and categories
4. **Earning/Redemption Rules**: Display brand-specific percentage rates and limits
5. **Status Indicators**: Show brand availability and current earning/redemption status

### Coin Balance Management
1. **Balance Calculation**: Sum all transactions (credits - debits) for current balance
2. **Transaction Types**: Support WELCOME_BONUS, EARNED, REDEEMED, EXPIRED
3. **Audit Trail**: Maintain complete transaction history with timestamps
4. **Balance Validation**: Ensure balance never goes negative during operations

## Database Schema Changes

### New Tables
- **`brands`**: Brand information, logos, earning/redemption percentages
- **`brand_categories`**: Brand categorization (e.g., Electronics, Fashion, Food)
- **`coin_balances`**: User coin balance tracking
- **`coin_transactions`**: Detailed transaction history with types and amounts

### Key Fields
- **Brand**: id, name, description, logo_url, category_id, earning_percentage, redemption_percentage, min_redemption_amount, max_redemption_amount, is_active
- **Coin Balance**: user_id, balance, last_updated
- **Coin Transaction**: id, user_id, amount, type, brand_id, description, created_at

## Integration Points

### Mobile App Integration
- **Navigation**: Add brands and coins to tab navigation
- **State Management**: Integrate with existing auth and user stores
- **API Calls**: Use existing HTTP client and error handling patterns

### Admin Portal Integration
- **Authentication**: Use existing admin auth system
- **Layout**: Integrate with existing admin dashboard structure
- **Form Validation**: Use existing form validation patterns

### Backend Integration
- **User Service**: Extend existing user creation flow
- **Auth Guards**: Apply existing JWT authentication
- **Validation**: Use existing DTO validation patterns
